<!DOCTYPE html>
<html>

<head>
    <title>Sandbox</title>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
        const lodash = window._;
        delete window._;

        const created = {};

        function createFn(id, code) {
            const wrapperCode = `
                const require = name => {
                    const m = modules[name];
                    if (!m) throw new Error('Module not found: ' + name);
                    return m;
                };

                ${code}
            `;
            try {
                const result = new Function('modules', wrapperCode)({ lodash });
                created[id] = typeof result === 'function' ? result : () => result;
            } catch (err) {
                created[id] = () => { throw err; };
            }

            return { source: 'sandbox', id, type: 'fn-created' };
        }

            async function evalFn(id, fnId, args) {
            let result;
            try {
                result = await Promise.all(args.map(async arg => {
                    const res = await created[fnId](arg);

                    if (typeof res === 'function') {
                        throw new Error('Cannot return a function');
                    }

                    return res;
                }));
            } catch (err) {
                console.error(err);
                result = err;
            }

            return { source: 'sandbox', id, type: 'fn-result', result };
        }

        window.addEventListener('message', async (evt) => {
            let response;

            if (evt.data.type === 'create-fn') {
                const { id, code } = evt.data;
                response = createFn(id, code);
            }

            if (evt.data.type === 'eval-fn') {
                const { id, fnId, arg } = evt.data;
                response = await evalFn(id, fnId, arg);
            }

            if (evt.data.type === 'ping') {
                response = { source: 'sandbox', type: 'pong' };
            }

            evt.source.postMessage(response, evt.origin);
        });

        window.addEventListener('beforeunload', (evt) => {
            window.parent.postMessage({ source: 'sandbox', type: 'sandbox-unloaded' }, '*');
        });

    window.parent.postMessage({ source: 'sandbox', type: 'sandbox-loaded' }, '*');
    </script>
</head>

</html>